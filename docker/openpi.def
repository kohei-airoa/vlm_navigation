Bootstrap: docker
From: nvidia/cuda:12.2.2-devel-ubuntu22.04

%environment
    export MUJOCO_GL=egl
    export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"

%post
    export DEBIAN_FRONTEND=noninteractive

    # Install utils & Python
    apt update && apt install -y --no-install-recommends \
        build-essential cmake \
        git git-lfs \
        nano vim less util-linux tree \
        htop atop nvtop \
        sed gawk grep curl wget zip unzip \
        sysstat screen tmux \
        libusb-1.0-0-dev libglib2.0-0 libgl1-mesa-glx libegl1-mesa \
        portaudio19-dev libgeos-dev \
        python3.10 python3.10-venv python3-pip \
        qtbase5-dev qtchooser qt5-qmake qtbase5-dev-tools \
        autoconf automake yasm \
        libass-dev libfreetype6-dev libgnutls28-dev libunistring-dev \
        libmp3lame-dev libtool libvorbis-dev meson ninja-build \
        pkg-config texinfo yasm zlib1g-dev nasm \
        libx264-dev libx265-dev libnuma-dev libvpx-dev \
        libfdk-aac-dev libopus-dev libsvtav1-dev libdav1d-dev \
        && apt clean && rm -rf /var/lib/apt/lists/*

    ln -s /usr/bin/python3 /usr/bin/python || true

    # Install poetry
    curl -sSL https://install.python-poetry.org | python - --version 1.8.5
    mv /root/.local/bin/poetry /usr/local/bin/
    poetry config virtualenvs.create false
    poetry config virtualenvs.in-project true

    # Install uv
    export UV_INSTALL_DIR=/usr/local/bin
    curl -sSL https://astral.sh/uv/install.sh | sh

    # Install GitHub CLI
    mkdir -p -m 755 /etc/apt/keyrings
    wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg \
        | tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null
    chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
        | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
    apt update && apt install -y gh && apt clean && rm -rf /var/lib/apt/lists/*

    mkdir -p /root/scripts

%files
    docker/scripts/. /root/scripts/

%runscript
    exec /bin/bash
